name: ORT License Compliance Scan
on:  
  workflow_dispatch:
    inputs:
      vcs_url:
        description: 'Repository URL to scan'
        required: true
        default: 'https://github.com/mtejaveluri/Testing-private'
      github_token:
        description: 'GitHub Personal Access Token for private repository access'
        required: false
        default: ''
jobs:
  ort-scan:
    runs-on: ubuntu-latest
    name: ORT License Compliance Check
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0        
        path: ".ort-config"
        
    - name: Setup ORT configuration files
      run: |
        # Create ORT config directory     
        mkdir -p "/$HOME/.ort/config"
        
        # Move Fetched Default Config into Place
        mv .ort-config "/$HOME/.ort/config"
     
        # Copy evaluator rules to ORT config directory
        cp /home/runner/.ort/config/.ort-config/evaluator.rules.kts "$HOME/.ort/config/evaluator.rules.kts"
        cp /home/runner/.ort/config/.ort-config/license-classifications.yml "$HOME/.ort/config/license-classifications.yml"

        echo "ORT configuration files setup complete"
    
    - name: Configure Git credentials for private repository access
      if: github.event.inputs.github_token != ''
      run: |
        # Configure git to use the token for authentication
        git config --global url."https://${{ github.event.inputs.github_token }}@github.com/".insteadOf "https://github.com/"
        git config --global url."https://oauth2:${{ github.event.inputs.github_token }}@github.com/".insteadOf "https://github.com/"
        # Store credentials for git credential helper
        git config --global credential.helper store
        echo "https://oauth2:${{ github.event.inputs.github_token }}@github.com" > ~/.git-credentials
        echo "https://${{ github.event.inputs.github_token }}@github.com" >> ~/.git-credentials
        # SSH configuration
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts 2>/dev/null || true
        chmod 600 ~/.git-credentials
    
    - name: Validate GitHub token and repository access
      if: github.event.inputs.github_token != ''
      run: |
        OWNER=$(echo "${{ github.event.inputs.vcs_url }}" | sed -E 's|.*github\.com[:/]([^/]+)/.*|\1|')
        REPO=$(echo "${{ github.event.inputs.vcs_url }}" | sed -E 's|.*github\.com[:/][^/]+/([^/.]+).*|\1|')
        
        echo "Testing token access to: $OWNER/$REPO"
        
        # Test if we can access the repository with the token
        if curl -s -H "Authorization: token ${{ github.event.inputs.github_token }}" \
          "https://api.github.com/repos/$OWNER/$REPO" | grep -q '"id"'; then
          echo "✓ Token is valid and has access to the repository"
        else
          echo "⚠ Token validation check: repository may be public or token may not have access"
        fi
    
    - name: Run ORT
      uses: oss-review-toolkit/ort-ci-github-action@v1
      env:
        GITHUB_TOKEN: ${{ github.event.inputs.github_token || secrets.GITHUB_TOKEN }}
        ORT_VCS_GIT_USERNAME: oauth2
        ORT_VCS_GIT_PASSWORD: ${{ github.event.inputs.github_token || secrets.GITHUB_TOKEN }}
        GIT_USERNAME: oauth2
        GIT_PASSWORD: ${{ github.event.inputs.github_token || secrets.GITHUB_TOKEN }}
      with:
        vcs-url: '${{ github.event.inputs.vcs_url }}'
        allow-dynamic-versions: 'true'
        run: >-
            cache-dependencies,
            labels,
            analyzer,
            scanner,
            advisor,
            evaluator,
            reporter,
            upload-results
        ort-cli-args: '-P ort.scanner.skipExcluded=true'
        ort-cli-scan-args: '--package-types=PROJECT'    
